//
//  MazeMap.swift
//  Spiral
//
//  Created by 杨萧玉 on 15/9/29.
//  Copyright © 2015年 杨萧玉. All rights reserved.
//

import GameplayKit
import SpriteKit

enum TileType: Int {
    case Open
    case Wall
    case Portal
    case Start
    case None
}

private let Maze = [
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,1,
    1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,
    1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,
    1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,
    1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,
    1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,
    1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,0,1,
    1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,0,1,
    1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,0,3,4,0,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,
    1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,1,
    1,1,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,1,1,
    1,1,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,1,1,
    1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,
    1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,0,1,
    1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,0,1,
    1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
    1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,
    1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,
    1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
]

private let MazeWidth: Int32 = 32
private let MazeHeight: Int32 = 28

private func tileAtRow(row: Int32, column col: Int32) -> TileType {
    return  TileType(rawValue: Maze[Int(row * MazeHeight + col)]) ?? .None
}

class MazeMap: SKNode {
    
    let width = MazeWidth
    
    let height = MazeHeight
    
    let pathfindingGraph: GKGridGraph = GKGridGraph(fromGridStartingAt: vector_int2(0, 0), width: MazeWidth, height: MazeHeight, diagonalsAllowed: false)
    
    var startPosition: GKGridGraphNode
    
    let shapeStartPositions: [GKGridGraphNode]
    
    init(size: CGSize) {
        
        var walls = [GKGridGraphNode]()
        var spawnPoints = [GKGridGraphNode]()
        startPosition = GKGridGraphNode(gridPosition: vector_int2(0, 0))
        
        for i in 0 ..< width {
            for j in 0 ..< height {
                let tile = tileAtRow(i, column: j)
                switch tile {
                case .Wall:
                    if let wall = pathfindingGraph.nodeAtGridPosition(vector_int2(i, j)) {
                        walls.append(wall)
                    }
                case .Portal:
                    if let portal = pathfindingGraph.nodeAtGridPosition(vector_int2(i, j)) {
                        spawnPoints.append(portal)
                    }
                case .Start:
                    startPosition = pathfindingGraph.nodeAtGridPosition(vector_int2(i, j))!
                default:
                    break
                }
            }
        }
        
        pathfindingGraph.removeNodes(walls)
        shapeStartPositions = spawnPoints
        
        super.init()
        
        // Generate maze.
        let maze = SKNode()
        let cellSize = CGSize(width: mazeCellWidth, height: mazeCellWidth)
        let graph = pathfindingGraph
        for i in 0 ..< width {
            for j in 0 ..< height {
                if graph.nodeAtGridPosition(vector_int2(i, j)) != nil,
                let scene = scene as? MazeModeScene {
                    //TODO:  绘制地图：墙和道路
                    let node = SKSpriteNode(color: SKColor.grayColor(), size: cellSize)
                    node.position = scene.pointForGridPosition(vector_int2(i, j))
                    maze.addChild(node)
                }
            }
        }
        addChild(maze)
    }

    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
}
